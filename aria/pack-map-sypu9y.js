/*
 * Copyright 2009-2014 Amadeus s.a.s.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
//***MULTI-PART
//*******************
//LOGICAL-PATH:aria/map/CfgBeans.js
//*******************
var e=require("../Aria"),t=require("../core/JsonTypes"),i=require("../core/CfgBeans");module.exports=e.beanDefinitions({$package:"aria.map.CfgBeans",$namespaces:{json:t,core:i},$beans:{MapCfg:{$type:"json:Object",$properties:{id:{$type:"json:String",$mandatory:!0},domElement:{$type:"json:ObjectRef",$mandatory:!0},initArgs:{$type:"json:MultiTypes",$default:{}}}},CreateMapCfg:{$type:"MapCfg",$properties:{provider:{$type:"json:String",$mandatory:!0},afterCreate:{$type:"core:Callback"}}}}});
//*******************
//LOGICAL-PATH:aria/map/MapManager.js
//*******************
var e=require("../Aria");require("./CfgBeans");var t=require("../templates/DomElementWrapper"),i=require("../utils/Type"),r=require("../core/JsonValidator");!function(){var a={},s={},n={},o={microsoft7:"aria.map.providers.Microsoft7MapProvider",google3:"aria.map.providers.Google3MapProvider"},l={},c={};module.exports=e.classDefinition({$classpath:"aria.map.MapManager",$singleton:!0,$constructor:function(){this._createdDomWrappers={}},$destructor:function(){this.destroyAllMaps();for(var e in c)c.hasOwnProperty(e)&&c[e].$dispose();s=null,n=null,this._createdDomWrappers=null,l=null,c=null,a=null,o=null},$events:{mapReady:"",mapDestroy:""},$statics:{INEXISTENT_PROVIDER:"Provider %1 cannot be found",INVALID_PROVIDER:"Provider %1 is not valid",DUPLICATED_PROVIDER:"Provider %1 exists already",DUPLICATED_MAP_ID:"A map with id %1 already exists.",LOADING:"loading",READY:"ready"},$prototype:{createMap:function(e){if(r.validateCfg("aria.map.CfgBeans.CreateMapCfg",e)){if(n[e.id])return void this.$logError(this.DUPLICATED_MAP_ID,e.id);n[e.id]=this.LOADING;var t=e.provider;t in o||this.addProvider(t,t),this._getProviderInstance(t,{fn:this._loadProviderDependencies,scope:this,args:e})}},getMap:function(e){return a[e]?a[e].instance:null},getMapDom:function(e){var i=this._createdDomWrappers[e];if(i)return i;var r=s[e];return r?(i=new t(r),this._createdDomWrappers[e]=i,i):void 0},destroyMap:function(e){var t=a[e];if(t){l[t.providerName].disposeMap(t.instance),t=null,delete a[e],delete s[e];var i=this._createdDomWrappers[e];i&&(i.$dispose(),i=null,delete this._createdDomWrappers[e]),delete n[e],this.$raiseEvent({name:"mapDestroy",mapId:e})}},destroyAllMaps:function(e){var t,i=e&&e in o;for(var r in a)a.hasOwnProperty(r)&&(t=a[r],i&&t.providerName!=e||this.destroyMap(r))},addProvider:function(e,t){o[e]?this.$logError(this.DUPLICATED_PROVIDER,e):i.isObject(t)?this._isValidProvider(t)?(l[e]=t,o[e]=t):this.$logError(this.INVALID_PROVIDER,e):o[e]=t},removeProvider:function(e){this.destroyAllMaps(e),delete o[e],c[e]&&(c[e].$dispose(),delete c[e]),delete l[e]},hasProvider:function(e){return e in o},_getProviderInstance:function(t,i){l[t]?this.$callback(i):e.load({classes:[o[t]],oncomplete:{fn:this._setProviderInstance,scope:this,args:{providerName:t,cb:i}},onerror:{fn:this._raiseInexistentProviderError,scope:this,args:{providerName:t,cb:i}}})},_raiseInexistentProviderError:function(e){this.$logError(this.INEXISTENT_PROVIDER,e.providerName);var t=e.cb.args;delete n[t.id];var i=t.afterCreate;i&&this.$callback(i,null)},_setProviderInstance:function(t){var r=t.providerName,a=e.getClassRef(o[r]),s=!i.isFunction(a),u=s?a:new a,h=this._isValidProvider(u);if(h)l[r]=u,s||(c[r]=u),this.$callback(t.cb);else{var p=t.cb.args;delete n[p.id],u.$dispose(),this.$logError(this.INVALID_PROVIDER,t.providerName);var d=p.afterCreate;d&&this.$callback(d,null)}},_isValidProvider:function(e){for(var t=!0,r=["load","getMap","disposeMap"],a=0;a<r.length;a++)t=t&&e[r[a]]&&i.isFunction(e[r[a]]);return t},_loadProviderDependencies:function(e,t){var i=l[t.provider];i.load({fn:this._retrieveMapInstance,scope:this,args:t})},_retrieveMapInstance:function(e,t){var i=e&&e.id&&e.provider?e:t,r=i.provider,o=i.id,c=i.afterCreate,u=l[r].getMap(i);a[o]={instance:u,providerName:r},s[o]=i.domElement,n[o]=this.READY,c&&this.$callback(c,u),this.$raiseEvent({name:"mapReady",mapId:o})},getMapStatus:function(e){return n[e]||null}}})}();
//*******************
//LOGICAL-PATH:aria/embed/controllers/MapController.js
//*******************
var e=require("../../Aria"),t=require("../../map/MapManager"),i=require("../../utils/Json");!function(){var r={},a={};module.exports=e.classDefinition({$classpath:"aria.embed.controllers.MapController",$singleton:!0,$constructor:function(){this.mapManager=t,this.mapManager.$addListeners({mapDestroy:{fn:this._nullifyMapDom,scope:this}}),this._listeners=0},$destructor:function(){this.mapManager.$removeListeners({mapDestroy:{fn:this._nullifyMapDom,scope:this}}),this.mapManager=null,r=null,a=null},$prototype:{onEmbeddedElementCreate:function(e,t){var i=this.mapManager.getMapStatus(t.id),a=r[t.id];null===i?this._createMap(e,t):e.appendChild(a),i=this.mapManager.getMapStatus(t.id),t.loadingIndicator&&i!=this.mapManager.READY&&this._activateLoadingIndicator(e,t)},_createMap:function(t,a){var s=i.copy(a);delete s.loadingIndicator;var n=e.$window.document.createElement("div");s.domElement=n,r[a.id]=n,t.appendChild(n),this.mapManager.createMap(s)},_activateLoadingIndicator:function(e,t){this._triggerLoadingIndicator(e,!0),a[t.id]={container:e},0===this._listeners&&this.mapManager.$addListeners({mapReady:{fn:this._removeLoadingIndicator,scope:this}}),this._listeners++},_removeLoadingIndicator:function(e){var t=a[e.mapId];t&&(this._triggerLoadingIndicator(t.container,!1),delete a[e.mapId],this._listeners--,0===this._listeners&&this.mapManager.$removeListeners({mapReady:{fn:this._removeLoadingIndicator,scope:this}}))},onEmbeddedElementDispose:function(e,t){var i=t.id;t.loadingIndicator&&this._triggerLoadingIndicator(e,!1);var a=r[i];if(a){var s=a.parentNode;s&&s.removeChild(a)}},_nullifyMapDom:function(e){delete r[e.mapId]},_triggerLoadingIndicator:function(e,t){e&&(t?aria.utils.DomOverlay.create(e):aria.utils.DomOverlay.detachFrom(e))}}})}();
//*******************
//LOGICAL-PATH:aria/embed/Map.js
//*******************
var e=require("../Aria"),t=require("./controllers/MapController"),i=require("./Element");module.exports=e.classDefinition({$classpath:"aria.embed.Map",$extends:i,$constructor:function(e){this.$Element.constructor.apply(this,arguments),this._cfg.controller=t,this._cfg.args={id:e.id,provider:e.provider,initArgs:e.initArgs,loadingIndicator:e.loadingIndicator}},$prototype:{_cfgBeanName:"aria.embed.CfgBeans.MapCfg"}});
//*******************
//LOGICAL-PATH:aria/map/providers/IMapProvider.js
//*******************
var e=require("../../Aria");module.exports=e.interfaceDefinition({$classpath:"aria.map.providers.IMapProvider",$interface:{load:function(){},getMap:function(){},disposeMap:function(){}}});
//*******************
//LOGICAL-PATH:aria/map/providers/Google3MapProvider.js
//*******************
var e=require("../../Aria"),t=require("../../utils/ScriptLoader"),i=require("./IMapProvider"),r=require("../../utils/Json");module.exports=e.classDefinition({$classpath:"aria.map.providers.Google3MapProvider",$singleton:!0,$implements:[i],$statics:{MISSING_ARGS:"Missing map arguments",MISSING_LATLNG:"Missing latitude (lat) or longitude (lng) in the initArgs of the map cfg"},$constructor:function(){this.credentials=""},$prototype:{load:function(i){if(this.isLoaded())this.$callback(i);else{var r=this;e.$window.__googleMapLoaded=function(){e.$window.__googleMapLoaded=null,r.$callback(i),r=null},t.load([this._getFullUrl()])}},isLoaded:function(){var t=e.$window.google;return!!(t&&t.maps&&t.maps.Map)},getMap:function(t){if(this.isLoaded()){if(!t.initArgs)return void this.$logError(this.MISSING_ARGS);var i=t.initArgs,a=i.lat,s=i.lng;if(null==a||null==s)return void this.$logError(this.MISSING_LATLNG);var n=e.$window.google,o={center:new n.maps.LatLng(a,s),zoom:i.zoom||10,mapTypeId:i.mapTypeId||n.maps.MapTypeId.ROADMAP,overviewMapControl:i.overviewMapControl!==!1,overviewMapControlOptions:{opened:i.overviewMapControlOpen!==!1}};r.inject(t.initArgs,o);var l=t.domElement;if(!l.offsetHeight){var c=l.parentNode;c&&(l.style.cssText="padding:0;margin:0;height:"+c.offsetHeight+"px;")}return new e.$window.google.maps.Map(l,o)}},disposeMap:function(e){var t=e.getDiv(),i=t.parentNode;i&&i.removeChild(t)},_getFullUrl:function(){var t=["/maps/api/js?v=3&sensor=false&callback=__googleMapLoaded"],i="https:"==e.$window.document.location.protocol,r=this.credentials;return r&&t.push((0===r.indexOf("gme-")?"client=":"key=")+r),(i?"https://maps-api-ssl.google.com":"http://maps.googleapis.com")+t.join("&")}}});
//*******************
//LOGICAL-PATH:aria/map/providers/Microsoft7MapProvider.js
//*******************
var e=require("../../Aria"),t=require("../../utils/ScriptLoader"),i=require("./IMapProvider"),r=require("../../utils/Json");module.exports=e.classDefinition({$classpath:"aria.map.providers.Microsoft7MapProvider",$singleton:!0,$implements:[i],$constructor:function(){this.credentials="",this._loadCallback=null},$destructor:function(){this._loadCallback=null},$prototype:{load:function(i){if(this.isLoaded())this.$callback(i);else{var r=this;this._loadCallback=i,e.$window.__bing7MapLoadCallback=function(){r._afterLoad.apply(r),r=null},t.load(["http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&mkt=en-US&onscriptload=__bing7MapLoadCallback"])}},_afterLoad:function(){this.$assert(35,this.isLoaded()),e.$window.__bing7MapLoadCallback=null;var t=this;e.$window.Microsoft.Maps.loadModule("Microsoft.Maps.Overlays.Style",{callback:function(){t.$callback(t._loadCallback),t=null}})},isLoaded:function(){return"undefined"!=typeof e.$window.Microsoft&&"undefined"!=typeof e.$window.Microsoft.Maps&&"undefined"!=typeof e.$window.Microsoft.Maps.Map},getMap:function(t){var i={credentials:this.credentials};return r.inject(t.initArgs,i),this.isLoaded()?new e.$window.Microsoft.Maps.Map(t.domElement,i):null},disposeMap:function(e){var t=e.getRootElement().parentNode;e.dispose(),t&&t.parentNode&&t.parentNode.removeChild(t)}}});